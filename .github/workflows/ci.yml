name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy

      - name: Install package
        run: pip install -e .

      - name: Run validation (NumPy only)
        run: |
          python -c "
          from d74169 import PrimeSonar, validate, benchmark, HAS_NUMBA
          print('d74169 CI Test')
          print('=' * 50)
          print(f'Numba: {\"enabled\" if HAS_NUMBA else \"disabled\"}')
          print()

          # Test basic functionality
          sonar = PrimeSonar(num_zeros=400, silent=True)
          primes = sonar.detect_primes(100)
          accuracy = sonar.test_accuracy(100)

          print(f'Primes up to 100: {len(primes)} found')
          print(f'Accuracy: {accuracy:.1f}%')

          assert accuracy == 100.0, f'Expected 100% accuracy, got {accuracy}%'
          assert len(primes) == 25, f'Expected 25 primes, got {len(primes)}'

          print()
          print('All tests passed!')
          "

  test-numba:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies with Numba
        run: |
          python -m pip install --upgrade pip
          pip install numpy numba

      - name: Install package
        run: pip install -e .

      - name: Run benchmark with Numba
        run: |
          python -c "
          from d74169 import benchmark, compare_methods, HAS_NUMBA

          print('d74169 Numba CI Test')
          print('=' * 50)
          assert HAS_NUMBA, 'Numba should be enabled'
          print('Numba: ENABLED')
          print()

          # Run benchmark
          results = benchmark([50, 100, 200, 500], silent=False)

          # Check all pass
          for r in results[:3]:  # First 3 should be perfect
              assert r.accuracy == 100.0, f'Range {r.range_max} failed: {r.accuracy}%'

          print()
          print('Numba tests passed!')
          "

  test-methods:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy

      - name: Install package
        run: pip install -e .

      - name: Test detection methods
        run: |
          python -c "
          from d74169 import PrimeSonar, compare_methods

          print('Testing detection methods...')
          results = compare_methods(200, 800, silent=False)

          # Adaptive should be best
          assert results['adaptive'].accuracy >= 95.0, 'Adaptive method failed'
          print()
          print('Method tests passed!')
          "
